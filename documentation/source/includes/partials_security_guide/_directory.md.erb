## Diretório de participantes

### Introdução

O Diretório de Participantes do Open Banking é o principal componente de arquitetura que permite que Instituições Provedoras (TPPs) se registrem e iniciem interações por meio de APIs com Instituições Transmissoras (ASPSPs), também fornece um ambiente de testes.
O Diretório é um serviço de gerenciamento de identidade e acesso que fornece informações de identidade que dão suporte aos participantes do Ecossistema do Open Banking.
O Diretório de Participantes disponibiliza os recursos funcionais necessários para que as Instituições Provedoras (TPPs) possam se autenticar no Open Banking e também recursos para identificar as Instituições Transmissoras (ASPSPs). 
O Registro dos Provedores é obrigatório para usar as APIs fornecidas pelas Instituições Transmissoras (ASPSPs).
As instituições Transmissoras devem utilizar as informações técnicas contidas no Diretório para realizar o gerenciamento da identidade e da autorização das aplicações das instituições Participantes, que abrange a identificação, a autorização e a revogação de certificados utilizados no compartilhamento de dados e serviços do escopo do Open Banking.
   
Recursos funcionais do Diretório de Participantes:
•	Gerenciar identidades e acesso: a capacidade de emitir e gerenciar registros de identidade para organizações e pessoas físicas que interagem com o Diretório.
•	Gerenciar certificados e chaves: A capacidade de fazer upload, gerenciar e remover certificados, chaves de assinatura e chaves de criptografia. A capacidade de emitir, gerenciar e revogar certificados digitais do Open Banking.
•	Gerenciar informações do Diretório: a capacidade de atualizar e localizar informações mantidas no diretório - por meio de APIs e/ou uma interface de usuário (IU).
   
###	Padrões 
   
•	Adoção de padrões abertos 
    o	O design do Diretório de Participantes do Open Banking será baseado em padrões abertos e amplamente adotados, como  API Restful, OpenID Connect e OAuth2.
•	Participantes devem estar registrados
    o	Os participantes devem ser autorizados e registrados na autoridade competente. 
•	Uso de certificados 
    o	 Os participantes que possuem um certificado válido podem se registrar no diretório mais rapidamente e sem a necessidade de realizar etapas manuais.
   
###	Registro de uma Instituição Provedora
   
O Diretório deverá realizar validações para o Registro de uma TPP, depois destas validações, solicitações e respostas de API e/ou dados de contas podem ser compartilhadas com segurança entre as duas partes. O diretório deve validar, se:
•	O TPP está utilizando um certificado digital.
•	O certificado se encontra em conformidade com os padrões do Open Banking Brasil.
•	O certificado não está expirado.
•	O certificado foi emitido por uma Entidade Emissora válida.
•	O certificado não foi revogado. 
Depois que todas as verificações forem realizadas, será estabelecido uma conexão TLS segura, mutuamente autenticada entre o Diretório e o TPP. 
   
###	Funções Operacionais dos Participantes
   
Fluxos para Instituições Provedoras (TPP)

IMAGEM

Fluxos para Instituições Transmissoras (ASPSP)

IMAGEM

###	Registro no diretório de participantes

Para poder consumir APIs disponibilizadas por um ASPSP, um TPP deverá realizar um registro junto ao ASPSP, esse processo de autenticação do participante deve ser feita de forma centralizada no Diretório de Participantes, sendo necessário a federação do seu portal ao Diretório.
O ASPSP deve implementar um processo de integração do TPP ao seu sistema, esse processo deve:
•	Validar se o TPP é autorizado por uma autoridade competente.
•	Validar as informações do TPP.
Após o TPP realizar o registro no Diretório de Participantes o mesmo poderá realizar o registro de clients (aplicações) na ASPSP.
Para a realização do registro de clients no Open Banking, é mandatório a disponibilização de dois processos: 
•	Registo de Client dinâmico, conforme [RFC 7591] (preferencial).
•	Registro Manual via Portal do Desenvolvedor (backup).


###	Registro de client dinâmico

O Registro Dinâmico de Client é mandatório para os participantes do Open Banking e deve ser utilizado preferencialmente. 
Com uma API de registro de client dinâmico do Open Banking, utilizando o padrão de segurança OpenID Connect, os TPPs podem se registrar junto aos ASPSPs.  
•	Para usar o Registro dinâmico de client, um TPP deve se registrar no Diretório de Participantes e obter um SSA e demais certificados digitais. 
•	O Client envia o SSA a um ASPSP para registro dinâmico no ASPSP. 
O diagrama abaixo mostra o fluxo do registro dinâmico de um TPP. 

Diagrama 7 - Fluxo de registro dinâmico.

Os TPPs precisam obter o SSA do Diretório de Participantes do Open Banking.  
Uma API de Registro dinâmico consiste em endpoints, que realizam a concessão de credencias do client e a autenticação mútua de TLS para autenticar o TPP. A API deve permitir que as seguintes operações sejam realizadas:
•	Registro de um Client. 
•	Recuperar um Client.
•	Atualizar um Client.
•	Excluir um Client.
    
###	Registro Manual via Portal do Desenvolvedor
    
Para que uma TPP comece a consumir serviços de Open Banking, ela deve estar registrada no Diretório de Participantes junto ao órgão regulador que autoriza e supervisiona os serviços Open Banking fornecidos pela TPP.
A realização de um registro manual deve ser feita apenas quando o registro dinâmico estiver indisponível, onde o TPP deverá solicitar via portal do ASPSP, na qual o ASPSP solicita informações do TPP através de um formulário durante o processo de inscrição e permite que o TPP utilize o ambiente de teste, sandbox e produção. 
O ASPSP aprovará o TPP com base em suas informações e permitirá que os aplicativos usem as APIs.
Segue um exemplo de processo de integração do TPP com o ASPSP via Portal do Desenvolvedor.

Diagrama 8 – Fluxo de registro manual.

### Teste e homologação

A fase de teste e homologação, tem como finalidade, garantir que os participantes que desejam operar no Ecossistema do Open Banking, possam fazer isso de forma assertiva e segura. Isso incluí o suporte aos TPPs com a capacidade de testar seus produtos e serviços desde o lançamento, quanto nas atualizações, fornecendo uma série de ferramentas e infraestrutura no serviço de Diretório para garantir que seus produtos tenham sido testados tempestivamente antes de entrar em produção.
É obrigatório o teste e a homologação para TPPs e ASPSPs. Instituições receptoras devem utilizar o serviço de Sandbox fornecido pelo Diretório.
As ASPSPs devem prover um ambiente de teste que possibilite TPPs autorizados a realizarem testes de conexão e testes funcionais de seus produtos e serviços. Este recurso deve refletir ao máximo o ambiente de produção e deve fornecer o acesso aos desenvolvedores com os seguintes aspectos:
•	Funcionalidade: Deve incluir todas as funcionalidades da interface de produção relacionadas aos casos de uso. Deve funcionar de maneira equivalente ou representativa para a interface de produção, incluindo casos de uso negativos e códigos de erro.
•	Segurança: Deve utilizar o mesmo perfil de segurança das APIs em produção.
•	 On-boarding: Deve replicar o processo de on-boarding das instalações de produção do ASPSP, incluindo o on-boarding e a troca de certificados para identificação e assinatura de mensagem.
•	 Certificados: Deve permitir o uso de certificados de teste (que têm o mesmo formato/estrutura dos certificados de produção) de modo que os TPPs possam replicar a funcionalidade relacionados à troca de certificados para identificação e assinatura de mensagens.
•	Dados de teste: Não deve incluir quaisquer dados reais de usuários finais. O volume e a variação dos dados devem ser suficientes para dar suporte a todos os testes técnicos e funcionais, incluindo paginação (onde for compatível com a interface dedicada).
•	Contas de teste: Deve fornecer aos TPPs um número de contas de teste que habilitem a funcionalidade e o acesso aos dados que os usuários reais experimentarão na produção.
•	Autenticação: O ASPSP deve fornecer recurso que permita que os TPPs testem os procedimentos de autenticação, inclusive em produção, utilizando suas próprias contas e/ou contas de teste.
•	 Disponibilidade e desempenho: Não deve lidar com volumes de produção (ou seja, não deve ser usada por ASPSPs ou TPPs para teste de estresse), no entanto, deve ter disponibilidade, capacidade, desempenho e outras características suficientes para facilitar a conexão eficaz e realista a testes funcionais do TPP.
•	Suporte: A instalação deve ter um nível apropriado de suporte para permitir a comunicação de problemas ou questões por TPPs para ASPSPs e fornecer soluções eficientes e eficazes. 
•	Documentação: ASPSPs devem publicar externamente um resumo das especificações da instalação de teste em seu site, incluindo detalhes de acesso e cobertura de teste. 

Os testes devem garantir escopo mínimo para cobrir todos os casos de uso e de requisitos de segurança, evidenciados de forma que seja possível garantir que o processo de homologação foi efetuado.
Os testes para TPPs devem acontecer em 3 etapas:
•	Testes de integração: Testes utilizando APIs de um Banco de exemplo no Sandbox do Diretório.
•	Testes no Ecossistema: Testes realizados no ecossistema apenas em Sandbox para validar novas funcionalidades ou melhorias.
•	Testes de primeira ocorrência: Testes baseados em acordos entre transmissoras e receptoras efetuados no ambiente de produção.

Ainda, recomenda-se que seja feito o teste de conformidade ao FAPI, disponível em https://openid.net/certification/fapi_op_testing/ .
